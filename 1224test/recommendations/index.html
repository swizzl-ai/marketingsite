<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Vehicle Recommendations</title>
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <style>
        :root {
            --primary-gradient: linear-gradient(135deg, #4568dc, #b06ab3);
            --card-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            --border-radius: 12px;
            --transition-speed: 0.3s;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Montserrat', sans-serif;
        }

        body {
            background-color: #f5f5f7;
            padding-top: 72px;
        }

        header {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            background: white;
            padding: 1rem;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            z-index: 100;
            height: 72px;
        }

        .logo {
            display: flex;
            justify-content: center;
            align-items: center;
        }

        .logo img {
            height: 40px;
        }

        .hero {
            background: var(--primary-gradient);
            padding: 3rem 2rem;
            text-align: center;
        }

        .hero h1 {
            color: white;
            font-size: 2.5rem;
            font-weight: 700;
        }

        .vehicle-table-container {
            padding: 2rem;
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: var(--border-radius);
            box-shadow: var(--card-shadow);
            position: relative;
        }

        .sticky-headers-container {
            position: sticky;
            top: 72px;
            z-index: 100;
            background: white;
            padding: 0 2rem;
            margin: 0 auto;
            max-width: 1200px;
            display: flex;
            gap: 2rem;
            justify-content: flex-start;
            overflow-x: auto;
            -ms-overflow-style: none;
            scrollbar-width: none;
        }

        .sticky-headers-container::-webkit-scrollbar {
            display: none;
        }

        .sticky-header {
            flex: 0 0 350px;
            padding: 1.5rem;
            background: #f5f5f7;
            font-weight: 600;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
        }

        .sticky-header.favorited {
            background: var(--primary-gradient);
            color: white;
        }

        .sticky-header.favorited .subtitle {
            color: rgba(255, 255, 255, 0.8);
        }

        .sticky-header .title {
            font-weight: 600;
            font-size: 1em;
        }

        .sticky-header .subtitle {
            font-size: 0.9em;
            color: #666;
            margin-top: 0.25rem;
            font-weight: 400;
        }

        .sticky-header .actions {
            display: flex;
            gap: 0.75rem;
        }

        .sticky-header.favorited .actions button {
            color: #f5f5f7;
        }

        .sticky-header .actions button {
            background: none;
            border: none;
            cursor: pointer;
            padding: 0.25rem;
            color: #666;
            transition: color 0.2s ease;
        }

        .sticky-header.favorited .actions button:hover {
            color: white;
        }

        .sticky-header .actions button:hover {
            color: #333;
        }

        .sticky-header .actions .heart:hover,
        .sticky-header .actions .heart.active {
            color: #e74c3c;
        }

        .sticky-header.favorited .actions .heart.active {
            color: #ff6b6b;
        }

        .sticky-header .actions .close:hover {
            color: #333;
        }

        .scrollable-content {
            overflow-x: auto;
            padding: 1rem 2rem;
            margin: 0 auto;
            max-width: 1200px;
            -ms-overflow-style: none;
            scrollbar-width: none;
        }

        .scrollable-content::-webkit-scrollbar {
            display: none;
        }

        .vehicle-threads {
            display: inline-flex;
            gap: 2rem;
            padding-bottom: 2rem;
            min-width: min-content;
        }

        .vehicle-thread {
            flex: 0 0 350px;
            display: flex;
            flex-direction: column;
            gap: 2rem;
            cursor: pointer;
            transition: transform 0.2s ease;
        }

        .vehicle-thread:hover {
            transform: translateY(-2px);
        }

        .vehicle-name {
            position: relative;
            background: #f5f5f7;
            padding: 1.5rem;
            font-weight: 600;
            color: #333;
            font-size: 1.1em;
            text-align: left;
            z-index: 99;
            border-bottom: 2px solid #f5f5f7;
            width: 350px;
            transition: transform 0.1s ease-out, background-color 0.3s ease, color 0.3s ease;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .vehicle-name.favorited {
            background: var(--primary-gradient);
            color: white;
        }

        .vehicle-name.favorited .subtitle {
            color: rgba(255, 255, 255, 0.8);
        }

        .vehicle-name .title {
            font-weight: 600;
            font-size: 1em;
            margin-right: 1rem;
        }

        .vehicle-name .subtitle {
            font-size: 0.9em;
            color: #666;
            margin-top: 0.25rem;
            font-weight: 400;
        }

        .vehicle-name .actions {
            display: flex;
            gap: 0.75rem;
        }

        .vehicle-name .actions button {
            background: none;
            border: none;
            cursor: pointer;
            padding: 0.25rem;
            color: #666;
            transition: color 0.2s ease;
        }

        .vehicle-name.favorited .actions button {
            color: #f5f5f7;
        }

        .vehicle-name .actions button:hover {
            color: #333;
        }

        .vehicle-name.favorited .actions button:hover {
            color: white;
        }

        .vehicle-name .actions .heart:hover,
        .vehicle-name .actions .heart.active {
            color: #e74c3c;
        }

        .vehicle-name.favorited .actions .heart.active {
            color: #ff6b6b;
        }

        .vehicle-name .actions .close:hover {
            color: #333;
        }

        .vehicle-name.favorited .actions .close:hover {
            color: white;
        }

        .vehicle-content {
            display: flex;
            flex-direction: column;
            gap: 0;
        }

        .specs-and-features {
            display: flex;
            flex-direction: column;
            gap: 0;
        }

        .feature-pills {
            margin: 0;
            padding: 0;
            display: flex;
            flex-wrap: wrap;
            gap: 0.15rem;
        }

        .feature-pills + .feature-pills {
            margin-top: 0.5rem;
        }

        .feature-pill {
            display: inline-flex;
            align-items: center;
            background: #f5f5f7;
            padding: 0.25rem 0.5rem;
            border-radius: 16px;
            margin: 0.15rem 0;
            font-size: 0.8rem;
            color: #4a4a4a;
        }

        .feature-pill.present, .feature-pill.not-present {
            background: #f5f5f7;
        }

        .specs-table {
            width: 100%;
            border-collapse: collapse;
            margin: 0 0 0.75rem 0;
            font-size: 0.8rem;
        }

        .specs-table table {
            width: 100%;
            border-collapse: collapse;
            margin: 0;
        }

        .specs-table table tr {
            border-bottom: 1px solid #e0e0e0;
        }

        .specs-table table tr:last-child {
            border-bottom: none;
        }

        .specs-table td {
            padding: 0.75rem 0;
            vertical-align: top;
            font-size: 0.8rem;
        }

        .specs-table table td:first-child {
            color: #666;
        }

        .vehicle-image {
            width: 100%;
            height: 200px;
            overflow: hidden;
            border-radius: var(--border-radius);
            margin-bottom: 1rem;
        }

        .vehicle-image img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .side-panel {
            position: fixed;
            top: 0;
            right: -50%;
            width: 50%;
            height: 100vh;
            background: white;
            box-shadow: -2px 0 8px rgba(0, 0, 0, 0.1);
            transition: right 0.3s ease;
            overflow-y: auto;
            z-index: 1001;
            padding: 2rem;
        }

        .side-panel.active {
            right: 0;
        }

        .overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100vh;
            background: rgba(0, 0, 0, 0.5);
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s ease;
            z-index: 1000;
        }

        .overlay.active {
            opacity: 1;
            visibility: visible;
        }

        body.sidebar-open {
            overflow: hidden;
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 2000;
        }

        .modal.active {
            display: flex;
            justify-content: center;
            align-items: center;
        }

        .action-buttons {
            position: absolute;
            top: 1rem;
            right: 1rem;
            display: flex;
            gap: 0.5rem;
            z-index: 5;
        }

        .has-sticky-header .action-buttons {
            z-index: 9;
        }

        .spacer {
            height: 80vh;
            width: 100%;
        }

        .section-content {
            margin-bottom: 1.5rem;
            padding: 1rem;
            background: white;
            border-radius: var(--border-radius);
            box-shadow: var(--card-shadow);
        }

        .section-content h3 {
            color: #333;
            margin-bottom: 1rem;
            font-size: 1.1rem;
        }

        .section-content .summary {
            color: #444;
            line-height: 1.6;
            font-size: 1rem;
            margin-bottom: 1rem;
        }

        .section-content-no-box {
            margin: 0;
            padding: 0;
        }

        .section-content-no-box h3 {
            font-size: 0.9rem;
            font-weight: 600;
            margin: 0.5rem 0 1.5rem 0;
        }

        .section-content-no-box .summary {
            font-size: 0.85rem;
            line-height: 1.4;
            color: #4a4a4a;
            margin: 0;
        }

        /* Add margin top to the first section after feature pills */
        .specs-and-features + .section-content-no-box {
            margin-top: 1rem;
        }

        /* Add margin between the two sections */
        .section-content-no-box + .section-content-no-box {
            margin-top: 1rem;
        }

        .dealer-section {
            margin-top: 2rem;
        }

        .dealer-section h3 {
            font-size: 1rem;
            font-weight: 600;
            margin-bottom: 1rem;
            color: #333;
        }

        .dealer-info {
            margin-bottom: 1rem;
            font-size: 0.875rem;
        }

        .dealer-info p {
            margin: 0.5rem 0;
            color: #666;
            line-height: 1.5;
        }

        .dealer-info strong {
            font-weight: 600;
            color: #333;
        }

        .dealer-info a {
            color: #4568dc;
            text-decoration: none;
        }

        .dealer-info a:hover {
            text-decoration: underline;
        }

        .dealer-cta {
            display: block;
            width: 100%;
            margin-top: 1rem;
            padding: 0.75rem 1.5rem;
            background: var(--primary-gradient);
            color: white;
            text-decoration: none;
            border-radius: 6px;
            font-weight: 500;
            font-size: 0.875rem;
            transition: opacity 0.2s ease;
            text-align: center;
        }

        .dealer-cta:hover {
            opacity: 0.9;
        }

        .map-container {
            height: 200px;
            border-radius: 8px;
            overflow: hidden;
            margin: 1rem 0;
            z-index: 1;
            position: relative;
            cursor: pointer;
        }

        .map-container::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: transparent;
            z-index: 2;
        }

        .map-container:hover::after {
            background: rgba(0, 0, 0, 0.1);
        }

        @supports (-webkit-touch-callout: none) {
            .vehicle-name.sticky {
                transform: translateZ(0);
            }
            .sticky-header-container {
                transform: translate3d(0,0,0);
                -webkit-transform: translate3d(0,0,0);
            }
        }
    </style>
</head>
<body>
    <header>
        <div class="logo">
            <img src="logo.png" alt="Logo">
        </div>
    </header>

    <main>
        <section class="hero">
            <h1>Recommended for you</h1>
        </section>

        <div class="vehicle-table-container">
            <div class="sticky-headers-container">
            </div>
            <div class="scrollable-content">
                <div class="vehicle-threads"></div>
            </div>
        </div>
    </main>

    <div class="side-panel"></div>

    <div class="overlay"></div>

    <div id="contact-modal" class="modal">
        <div class="modal-content">
            <h2>Contact the Dealer</h2>
            <form id="contact-form">
                <div class="form-group">
                    <label for="to-email">To:</label>
                    <input type="email" id="to-email" value="sales@yourdealer.com" readonly>
                </div>
                <div class="form-group">
                    <label for="from-email">From:</label>
                    <input type="email" id="from-email" value="john@youremail.com" readonly>
                </div>
                <div class="form-group">
                    <label for="message">Message:</label>
                    <textarea id="message" rows="6"></textarea>
                </div>
                <button type="submit" class="send-button">Send</button>
            </form>
        </div>
    </div>

    <div class="spacer"></div>

    <script src="data.js"></script>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script>
        class VehicleCardManager {
            constructor() {
                this.mainHeaderHeight = 72;
                this.vehiclesContainer = document.querySelector('.vehicle-threads');
                this.stickyHeadersContainer = document.querySelector('.sticky-headers-container');
                this.sidePanel = document.querySelector('.side-panel');
                this.currentIndex = 0;
                this.unusedVehicles = [...vehicleData.cars];  // Create a copy of all vehicles
                this.displayedVehicles = [];  // Track currently displayed vehicles
                this.setupEventListeners();
                this.loadMoreVehicles();
            }

            loadMoreVehicles() {
                if (this.unusedVehicles.length > 0) {
                    // Take first 3 vehicles from unused list
                    const vehicles = this.unusedVehicles.splice(0, 3);
                    this.displayedVehicles.push(...vehicles);
                    this.renderVehicles(vehicles);
                }
            }

            async renderVehicles(vehicles) {
                this.stickyHeadersContainer.innerHTML = '';
                this.vehiclesContainer.innerHTML = '';

                for (const vehicle of vehicles) {
                    const header = document.createElement('div');
                    header.className = 'sticky-header';
                    
                    const titleWrapper = document.createElement('div');
                    titleWrapper.className = 'title-wrapper';
                    
                    const title = document.createElement('div');
                    title.className = 'title';
                    title.textContent = vehicle.title;
                    
                    const subtitle = document.createElement('div');
                    subtitle.className = 'subtitle';
                    
                    const priceSpec = vehicle.key_specs?.find(spec => spec?.toLowerCase().startsWith('price:'));
                    let priceRange = '';
                    if (priceSpec) {
                        const prices = priceSpec.match(/\$[\d,]+/g);
                        if (prices && prices.length >= 2) {
                            priceRange = `$${(parseInt(prices[0].replace(/[\$,]/g, '')) / 1000).toFixed(0)}k-${(parseInt(prices[1].replace(/[\$,]/g, '')) / 1000).toFixed(0)}k`;
                        } else if (prices && prices.length === 1) {
                            priceRange = `$${(parseInt(prices[0].replace(/[\$,]/g, '')) / 1000).toFixed(0)}k`;
                        }
                    }
                    
                    subtitle.textContent = `${vehicle.year || '2025'} • ${priceRange} • New`;
                    
                    titleWrapper.appendChild(title);
                    titleWrapper.appendChild(subtitle);
                    
                    const actions = document.createElement('div');
                    actions.className = 'actions';
                    
                    const heartBtn = document.createElement('button');
                    heartBtn.className = 'heart';
                    heartBtn.innerHTML = '<i class="fa-regular fa-heart"></i>';
                    
                    const closeBtn = document.createElement('button');
                    closeBtn.className = 'close';
                    closeBtn.innerHTML = '<i class="fa-solid fa-xmark"></i>';
                    
                    actions.appendChild(heartBtn);
                    actions.appendChild(closeBtn);
                    
                    header.appendChild(titleWrapper);
                    header.appendChild(actions);
                    
                    this.stickyHeadersContainer.appendChild(header);

                    const thread = await this.createVehicleThread(vehicle);
                    this.vehiclesContainer.appendChild(thread);
                }

                this.setupScrollSync();
            }

            async createVehicleThread(vehicle) {
                const thread = document.createElement('div');
                thread.className = 'vehicle-thread';
                
                const content = document.createElement('div');
                content.className = 'vehicle-content';
                
                const imageContainer = document.createElement('div');
                imageContainer.className = 'vehicle-image';
                const img = document.createElement('img');
                
                try {
                    const currentYear = new Date().getFullYear();
                    const response = await fetch(`https://cars.swizzl.ai/cars/images/${encodeURIComponent(vehicle.title)} ${currentYear}`);
                    const imageData = await response.json();
                    
                    if (imageData && imageData.length > 0 && imageData[0].link) {
                        img.src = imageData[0].link;
                    } else {
                        throw new Error('No image found');
                    }
                } catch (error) {
                    img.src = 'https://via.placeholder.com/300x200?text=Vehicle+Image+Not+Available';
                    console.error('Error loading image:', error);
                }
                
                img.alt = vehicle.title;
                img.onerror = function() {
                    this.src = 'https://via.placeholder.com/300x200?text=Vehicle+Image+Not+Available';
                };
                
                imageContainer.appendChild(img);
                content.appendChild(imageContainer);

                // Create container for specs and features
                const specsAndFeatures = document.createElement('div');
                specsAndFeatures.className = 'specs-and-features';

                // Add key specs table if available
                if (Array.isArray(vehicle.key_specs) && vehicle.key_specs.length > 0) {
                    const specsTable = document.createElement('table');
                    specsTable.className = 'specs-table';
                    
                    // Create inner table for specs
                    const innerTable = document.createElement('table');
                    vehicle.key_specs.forEach(spec => {
                        const [key, ...valueParts] = spec.split(':');
                        const value = valueParts.join(':').trim();
                        
                        const specRow = document.createElement('tr');
                        const keyCell = document.createElement('td');
                        keyCell.textContent = key;
                        const valueCell = document.createElement('td');
                        valueCell.textContent = value;
                        specRow.appendChild(keyCell);
                        specRow.appendChild(valueCell);
                        innerTable.appendChild(specRow);
                    });
                    specsTable.appendChild(innerTable);
                    specsAndFeatures.appendChild(specsTable);
                }
                
                // Add feature pills
                if (vehicle.present && Array.isArray(vehicle.present.list)) {
                    const pillsContainer = document.createElement('div');
                    pillsContainer.className = 'feature-pills';
                    
                    vehicle.present.list.forEach(feature => {
                        const pill = document.createElement('span');
                        pill.className = 'feature-pill present';
                        pill.innerHTML = `<i class="fas fa-check" style="color: #22c55e; margin-right: 4px;"></i>${feature}`;
                        pillsContainer.appendChild(pill);
                    });
                    
                    specsAndFeatures.appendChild(pillsContainer);
                }
                
                if (vehicle.not_present && Array.isArray(vehicle.not_present.list)) {
                    const pillsContainer = document.createElement('div');
                    pillsContainer.className = 'feature-pills';
                    
                    vehicle.not_present.list.forEach(feature => {
                        const pill = document.createElement('span');
                        pill.className = 'feature-pill not-present';
                        pill.innerHTML = `<i class="fas fa-times" style="color: #ef4444; margin-right: 4px;"></i>${feature}`;
                        pillsContainer.appendChild(pill);
                    });
                    
                    specsAndFeatures.appendChild(pillsContainer);
                }

                content.appendChild(specsAndFeatures);

                // Handle fits_your_needs and potential_gaps with summaries
                const sections = [
                    { name: 'fits_your_needs', source: 'present' },
                    { name: 'potential_gaps', source: 'not_present' }
                ];
                
                sections.forEach(({ name, source }) => {
                    const section = document.createElement('div');
                    section.className = 'section-content-no-box';
                    
                    const title = document.createElement('h3');
                    title.textContent = name.replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase());
                    section.appendChild(title);
                    
                    if (vehicle[source] && typeof vehicle[source] === 'object' && vehicle[source].summary) {
                        const summary = document.createElement('p');
                        summary.className = 'summary';
                        summary.textContent = vehicle[source].summary;
                        section.appendChild(summary);
                    }
                    
                    content.appendChild(section);
                });

                // Add tradeoffs section at the bottom
                if (vehicle.tradeoffs && vehicle.tradeoffs.list && Array.isArray(vehicle.tradeoffs.list)) {
                    const tradeoffsSection = document.createElement('div');
                    tradeoffsSection.className = 'section-content-no-box';
                    
                    const title = document.createElement('h3');
                    title.textContent = 'Tradeoffs You\'ll Need to Make';
                    tradeoffsSection.appendChild(title);
                    
                    const tradeoffsList = document.createElement('ul');
                    tradeoffsList.className = 'summary';
                    tradeoffsList.style.listStyleType = 'disc';
                    tradeoffsList.style.paddingLeft = '1.5rem';
                    
                    vehicle.tradeoffs.list.forEach(tradeoff => {
                        const tradeoffItem = document.createElement('li');
                        tradeoffItem.textContent = tradeoff;
                        tradeoffItem.style.marginBottom = '0.5rem';
                        tradeoffsList.appendChild(tradeoffItem);
                    });
                    
                    tradeoffsSection.appendChild(tradeoffsList);
                    content.appendChild(tradeoffsSection);
                }
                
                // Add dealer section
                if (vehicle.dealer) {
                    const dealerSection = document.createElement('div');
                    dealerSection.className = 'dealer-section';

                    const dealerTitle = document.createElement('h3');
                    dealerTitle.textContent = 'Where To Get It';
                    dealerSection.appendChild(dealerTitle);

                    // Add map container right after title
                    const mapContainer = document.createElement('div');
                    mapContainer.className = 'map-container';
                    dealerSection.appendChild(mapContainer);

                    // Make map container clickable to open Google Maps
                    mapContainer.addEventListener('click', () => {
                        const googleMapsUrl = `https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(vehicle.dealer.address)}`;
                        window.open(googleMapsUrl, '_blank', 'noopener');
                    });

                    const dealerInfo = document.createElement('div');
                    dealerInfo.className = 'dealer-info';

                    const dealerName = document.createElement('p');
                    dealerName.innerHTML = `<strong>${vehicle.dealer.name}</strong>`;
                    dealerInfo.appendChild(dealerName);

                    const dealerAddress = document.createElement('p');
                    dealerAddress.textContent = vehicle.dealer.address;
                    dealerInfo.appendChild(dealerAddress);

                    dealerSection.appendChild(dealerInfo);

                    // Add CTA button
                    const ctaButton = document.createElement('a');
                    ctaButton.className = 'dealer-cta';
                    ctaButton.href = vehicle.dealer.website;
                    ctaButton.target = '_blank';
                    ctaButton.rel = 'noopener noreferrer';
                    ctaButton.textContent = 'Visit Dealer Website';
                    dealerSection.appendChild(ctaButton);

                    content.appendChild(dealerSection);

                    // Initialize map after the container is added to the DOM
                    setTimeout(async () => {
                        const map = L.map(mapContainer, {
                            dragging: false,
                            touchZoom: false,
                            scrollWheelZoom: false,
                            doubleClickZoom: false,
                            boxZoom: false,
                            keyboard: false,
                            zoomControl: false
                        });

                        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                            attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
                        }).addTo(map);

                        try {
                            // Use Nominatim geocoding service
                            const response = await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(vehicle.dealer.address)}`);
                            const data = await response.json();
                            
                            if (data && data.length > 0) {
                                const lat = parseFloat(data[0].lat);
                                const lon = parseFloat(data[0].lon);
                                
                                map.setView([lat, lon], 15);
                                const marker = L.marker([lat, lon]).addTo(map);
                            } else {
                                console.error('Address not found');
                                mapContainer.style.display = 'none';
                            }
                        } catch (error) {
                            console.error('Error geocoding address:', error);
                            mapContainer.style.display = 'none';
                        }
                    }, 100);
                }

                thread.appendChild(content);
                return thread;
            }

            setupEventListeners() {
                document.addEventListener('click', (e) => {
                    const heartBtn = e.target.closest('.heart');
                    const closeBtn = e.target.closest('.close');
                    const thread = e.target.closest('.vehicle-thread');
                    const header = e.target.closest('.sticky-header');
                    
                    if (heartBtn) {
                        const header = heartBtn.closest('.sticky-header');
                        header.classList.toggle('favorited');
                        const icon = heartBtn.querySelector('i');
                        icon.className = header.classList.contains('favorited') ? 
                            'fa-solid fa-heart' : 'fa-regular fa-heart';
                    }
                    
                    if (closeBtn) {
                        const header = closeBtn.closest('.sticky-header');
                        const index = Array.from(this.stickyHeadersContainer.children).indexOf(header);
                        if (index !== -1) {
                            // Remove the current vehicle
                            header.remove();
                            this.vehiclesContainer.children[index].remove();
                            
                            // Remove from displayed vehicles
                            this.displayedVehicles.splice(index, 1);
                            
                            // If we have unused vehicles, add a new one
                            if (this.unusedVehicles.length > 0) {
                                const nextVehicle = this.unusedVehicles.shift(); // Take the next unused vehicle
                                this.displayedVehicles.push(nextVehicle);
                                
                                // Create and append new header
                                const newHeader = document.createElement('div');
                                newHeader.className = 'sticky-header';
                                
                                const titleWrapper = document.createElement('div');
                                titleWrapper.className = 'title-wrapper';
                                
                                const title = document.createElement('div');
                                title.className = 'title';
                                title.textContent = nextVehicle.title;
                                
                                const subtitle = document.createElement('div');
                                subtitle.className = 'subtitle';
                                
                                const priceSpec = nextVehicle.key_specs?.find(spec => spec?.toLowerCase().startsWith('price:'));
                                let priceRange = '';
                                if (priceSpec) {
                                    const prices = priceSpec.match(/\$[\d,]+/g);
                                    if (prices && prices.length >= 2) {
                                        priceRange = `$${(parseInt(prices[0].replace(/[\$,]/g, '')) / 1000).toFixed(0)}k-${(parseInt(prices[1].replace(/[\$,]/g, '')) / 1000).toFixed(0)}k`;
                                    } else if (prices && prices.length === 1) {
                                        priceRange = `$${(parseInt(prices[0].replace(/[\$,]/g, '')) / 1000).toFixed(0)}k`;
                                    }
                                }
                                
                                subtitle.textContent = `${nextVehicle.year || '2025'} • ${priceRange} • New`;
                                
                                titleWrapper.appendChild(title);
                                titleWrapper.appendChild(subtitle);
                                
                                const actions = document.createElement('div');
                                actions.className = 'actions';
                                
                                const heartBtn = document.createElement('button');
                                heartBtn.className = 'heart';
                                heartBtn.innerHTML = '<i class="fa-regular fa-heart"></i>';
                                
                                const closeBtn = document.createElement('button');
                                closeBtn.className = 'close';
                                closeBtn.innerHTML = '<i class="fa-solid fa-xmark"></i>';
                                
                                actions.appendChild(heartBtn);
                                actions.appendChild(closeBtn);
                                
                                newHeader.appendChild(titleWrapper);
                                newHeader.appendChild(actions);
                                
                                this.stickyHeadersContainer.appendChild(newHeader);

                                // Create and append new vehicle thread
                                this.createVehicleThread(nextVehicle).then(thread => {
                                    this.vehiclesContainer.appendChild(thread);
                                });
                            }
                        }
                    }
                    
                    if (thread || (header && !heartBtn && !closeBtn)) {
                        const index = thread ? 
                            Array.from(this.vehiclesContainer.children).indexOf(thread) :
                            Array.from(this.stickyHeadersContainer.children).indexOf(header);
                        this.openSidePanel(vehicleData.cars[index]);
                    }
                });

                this.setupScrollSync();
            }

            setupScrollSync() {
                const content = document.querySelector('.scrollable-content');
                content.addEventListener('scroll', () => {
                    this.stickyHeadersContainer.scrollLeft = content.scrollLeft;
                });
            }

            openSidePanel(vehicle) {
                if (!this.sidePanel) return;
                
                this.sidePanel.innerHTML = '';
                
                const closeButton = document.createElement('button');
                closeButton.className = 'close-panel';
                closeButton.innerHTML = '<i class="fas fa-times"></i>';
                closeButton.addEventListener('click', () => this.closeSidePanel());
                this.sidePanel.appendChild(closeButton);
                
                const content = document.createElement('div');
                content.className = 'side-panel-content';
                
                const title = document.createElement('h2');
                title.textContent = vehicle.title;
                content.appendChild(title);
                
                const imageSection = document.createElement('div');
                imageSection.className = 'section-content';
                const img = document.createElement('img');
                img.className = 'vehicle-image';
                const existingImage = document.querySelector(`.vehicle-thread img[alt="${vehicle.title}"]`);
                img.src = existingImage ? existingImage.src : 'https://via.placeholder.com/300x200?text=Vehicle+Image+Not+Available';
                img.alt = vehicle.title;
                imageSection.appendChild(img);
                content.appendChild(imageSection);
                
                ['fits_your_needs', 'potential_gaps', 'key_specs'].forEach(sectionName => {
                    const section = document.createElement('div');
                    section.className = 'section-content-no-box';
                    
                    const sectionTitle = document.createElement('h3');
                    sectionTitle.textContent = sectionName.replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase());
                    section.appendChild(sectionTitle);
                    
                    if (vehicle[sectionName] && typeof vehicle[sectionName] === 'object' && vehicle[sectionName].summary) {
                        const summary = document.createElement('p');
                        summary.className = 'summary';
                        summary.textContent = vehicle[sectionName].summary;
                        section.appendChild(summary);
                    }
                    
                    content.appendChild(section);
                });

                this.sidePanel.appendChild(content);
                this.sidePanel.classList.add('active');
                document.body.classList.add('sidebar-open');
                
                const overlay = document.querySelector('.overlay') || this.createOverlay();
                overlay.classList.add('active');
                overlay.addEventListener('click', () => this.closeSidePanel());
            }

            closeSidePanel() {
                this.sidePanel.classList.remove('active');
                document.querySelector('.overlay').classList.remove('active');
                document.body.classList.remove('sidebar-open');
            }

            createOverlay() {
                const overlay = document.createElement('div');
                overlay.className = 'overlay';
                document.body.appendChild(overlay);
                return overlay;
            }
        }

        document.addEventListener('DOMContentLoaded', () => {
            const manager = new VehicleCardManager();
        });
    </script>
</body>
</html>